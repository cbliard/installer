#!/bin/bash

echo "Configuring"
echo $APP_NAME
echo $INSTALLER_DIR

. "${INSTALLER_DIR}/wizard"

input_start() {
	# returns an error only if key can't be found
	wiz_put "mysql/autoinstall"
	# is true when user clicked OK, or false if user clicked CANCEL, ESC, etc.
	if wiz_ask ; then
		RET=$(wiz_get "mysql/autoinstall")
		echo $RET
		case "$RET" in
			"skip")
				STATE="done"
				;;
			"install")
				STATE="done"
				;;
			"reuse")
				STATE="mysql_params"
				;;
		esac
	else
		STATE="done"
	fi
}

input_mysql_params() {
	echo "input connection infos"
	wiz_put "mysql/db_host"
	wiz_put "mysql/db_port"

	local dbc_host=$(wiz_get "mysql/db_host")
	if [ "$dbc_host" = "127.0.0.1" ] || [ "$dbc_host" = "localhost" ]; then
		wiz_set "mysql/db_source_host" "${dbc_host}"
	else
		wiz_set "mysql/db_source_host" "$(hostname -f)"
	fi
	wiz_put "mysql/db_source_host"
	wiz_put "mysql/db_username"
	wiz_put "mysql/db_password"

	if wiz_ask ; then
		STATE="done"
	else
		STATE="start"
	fi
}

state_machine() {
	case "$STATE" in
		"start")
			input_start
			;;
		"mysql_params")
			input_mysql_params
			;;
		"super_user_params")
			input_super_user_params
			;;
		"existing_user_params")
			input_existing_user_params
			;;
		"done")
			break
			;;
		*)
			echo "invalid state ${STATE}"
			break
			;;
	esac
}

wizard "start"
